import{u as T,r as l,j as e,ay as R}from"./index-BmJdQGgB.js";import{P as S}from"./PageTitle-DvSd9fON.js";import{d as u}from"./dayjs.min-tbsB4tHL.js";const C=()=>{const{ticketId:r}=T(),[m,v]=l.useState(null),[h,p]=l.useState(null),[x,g]=l.useState(""),[i,n]=l.useState(null),j=l.useRef(null),c=l.useRef(null),d=(s,t)=>{p({type:s,text:t}),setTimeout(()=>p(null),3e3)},f=async s=>{try{const t=await fetch(`http://localhost:3000/tickets/${s}`);if(!t.ok)throw new Error("Network response was not ok");const o=await t.json();v(o),setTimeout(()=>{var b;(b=j.current)==null||b.scrollIntoView({behavior:"smooth"})},100)}catch(t){console.error(t),d("danger","Lấy dữ liệu ticket thất bại")}};l.useEffect(()=>{r&&f(r)},[r]);const a=l.useMemo(()=>m||{},[m]),N=a.messages||[],w=async()=>{if(!x.trim()&&!i){d("danger","Vui lòng nhập nội dung hoặc chọn hình ảnh");return}const s=new FormData,t=2;s.append("message",x),s.append("userId",t.toString()),i&&s.append("image",i);try{if(!(await fetch(`http://localhost:3000/tickets/${r}/reply`,{method:"POST",body:s})).ok)throw new Error("Lỗi server khi gửi phản hồi");g(""),n(null),c.current&&(c.current.value=""),d("success","Đã gửi phản hồi"),f(r)}catch(o){console.error(o),d("danger","Gửi phản hồi thất bại")}},y=s=>{const t=s.target.files[0];n(t||null)},k=()=>{n(null),c.current&&(c.current.value="")};return m?e.jsxs("div",{className:"container-fluid",children:[e.jsx(S,{title:`Chi tiết Ticket #${a.id||""}`,subtitle:"Support Tickets"}),h&&e.jsx("div",{className:"toast-container position-fixed top-0 end-0 p-3",style:{zIndex:1080},children:e.jsx("div",{className:`toast show bg-${h.type} text-white`,children:e.jsx("div",{className:"toast-body fw-semibold",children:h.text})})}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-lg-8",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header bg-primary text-white fw-semibold",children:"Cuộc hội thoại"}),e.jsxs("div",{className:"card-body",style:{maxHeight:"60vh",overflowY:"auto"},children:[N.map(s=>e.jsxs("div",{className:"d-flex align-items-start gap-3 mb-3",children:[e.jsx("div",{className:"avatar-sm bg-primary-subtle rounded-circle d-flex align-items-center justify-content-center flex-shrink-0",children:e.jsx("span",{className:"fw-bold",children:s.sender.username[0].toUpperCase()})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("span",{className:"fw-semibold",children:s.sender.username}),e.jsx("span",{className:`badge ${s.sender.role==="admin"?"bg-danger text-white":"bg-secondary-subtle text-muted"}`,children:s.sender.role==="admin"?"Admin":"Khách hàng"}),e.jsx("span",{className:"text-muted small ms-auto",children:u(s.createdAt).format("HH:mm DD/MM/YYYY")})]}),e.jsxs("div",{className:"mt-2 p-3 rounded border bg-light",children:[s.message&&e.jsx("p",{className:"mb-0",style:{whiteSpace:"pre-wrap"},children:s.message}),s.image&&e.jsx("div",{className:"mt-2",children:e.jsx("a",{href:s.image,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:`${R}/uploads/tickets/${s.image}`,alt:"Attached",style:{maxWidth:"200px",maxHeight:"200px",borderRadius:4,cursor:"pointer"}})})})]})]})]},s.id)),e.jsx("div",{ref:j})]}),e.jsx("div",{className:"card-footer",children:e.jsxs("div",{className:"d-flex flex-column gap-2",children:[e.jsx("textarea",{className:"form-control",rows:"3",placeholder:"Nhập phản hồi của bạn...",value:x,onChange:s=>g(s.target.value)}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("input",{ref:c,className:"form-control form-control-sm",type:"file",accept:"image/*",onChange:y}),i&&e.jsxs("div",{className:"mt-2",children:[e.jsx("img",{src:URL.createObjectURL(i),alt:"Preview",style:{maxWidth:"100px",maxHeight:"100px",borderRadius:4}}),e.jsx("button",{onClick:k,className:"btn btn-sm btn-danger ms-2",children:"Xóa ảnh"})]})]}),e.jsx("button",{className:"btn btn-primary",onClick:w,children:"Gửi phản hồi"})]})]})})]})}),e.jsxs("div",{className:"col-lg-4",children:[e.jsxs("div",{className:"card mb-3",children:[e.jsx("div",{className:"card-header bg-info-subtle fw-semibold",children:"Thông tin ticket"}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-2",children:[e.jsxs("span",{className:"badge bg-primary-subtle text-primary me-2",children:["ID: #",a.id]}),e.jsx("span",{className:"badge bg-success-subtle text-success text-uppercase",children:a.status})]}),e.jsx("div",{className:"small text-muted",children:"Tiêu đề"}),e.jsx("div",{className:"fw-semibold mb-2",children:a.title}),e.jsx("div",{className:"small text-muted",children:"Ngày tạo"}),e.jsx("div",{className:"mb-2",children:u(a.createdAt).format("DD/MM/YYYY HH:mm")}),e.jsx("div",{className:"small text-muted",children:"Cập nhật lần cuối"}),e.jsx("div",{children:u(a.updatedAt).format("DD/MM/YYYY HH:mm")})]})]}),a.user&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header bg-info-subtle fw-semibold",children:"Thông tin khách hàng"}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3 mb-3",children:[e.jsx("div",{className:"avatar-sm bg-primary-subtle rounded-circle d-flex align-items-center justify-content-center flex-shrink-0",children:e.jsx("span",{className:"fw-bold",children:a.user.username[0].toUpperCase()})}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-semibold",children:a.user.username}),e.jsx("div",{className:"text-muted small",children:a.user.email})]})]}),e.jsxs("div",{className:"row g-2",children:[e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"p-2 rounded border text-center",children:[e.jsxs("div",{className:"fs-5 fw-bolder",children:[parseFloat(a.user.balance).toLocaleString("vi-VN"),"đ"]}),e.jsx("div",{className:"text-muted small",children:"Số dư"})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"p-2 rounded border text-center",children:[e.jsxs("div",{className:"fs-5 fw-bolder",children:[parseFloat(a.user.totalTopup).toLocaleString("vi-VN"),"đ"]}),e.jsx("div",{className:"text-muted small",children:"Đã nạp"})]})})]})]})]})]})]})]}):e.jsx("div",{children:"Đang tải dữ liệu..."})};export{C as default};
